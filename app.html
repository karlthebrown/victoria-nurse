<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Cache-Control" content="no-store, max-age=0"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Victoria Nurse ‚Äî We Care Together</title>

  <!-- Version -->
  <script>window.__VN_VER__="2025-09-17-49";</script>

  <!-- PWA + Icons -->
  <link rel="manifest" href="./manifest.webmanifest?v=2025-09-17-49"/>
  <meta name="theme-color" content="#0EA5E9"/>
  <link rel="icon" type="image/png" href="./icons/favicon.png?v=2025-09-17-49"/>
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180.png?v=2025-09-17-49"/>

  <!-- Tailwind + PDF libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{ --med-teal:#14B8A6; --med-sky:#0EA5E9; --med-indigo:#1E40AF; --label:#0891B2; }

    /* Help-page colors */
    body { background:#f9fafb; }
    .text-body { color:#1f2937; } /* slate-800-ish */

    /* Gradient text used for title + tagline */
    .gradient-text {
      background: linear-gradient(90deg, #14B8A6, #0EA5E9, #1E40AF);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    /* Inputs */
    .vn-field{ padding:.95rem 1.1rem; border-radius:.9rem; border:1px solid #cbd5e1; background:#fff; line-height:1.6rem; }
    .vn-field:focus{ outline:none; box-shadow:0 0 0 2px var(--label); border-color:var(--label); }
    .vn-input{ height:3.25rem; } .vn-textarea{ min-height:3.5rem; }

    /* Buttons ‚Äî slimmer width */
    .btn-grad{
      background-image:linear-gradient(90deg, var(--med-teal), var(--med-sky), var(--med-indigo));
      color:#fff; font-weight:700; padding:.75rem 1.1rem; border-radius:999px;
      box-shadow:0 10px 24px rgba(0,0,0,.22);
      transition: transform .12s ease, opacity .12s ease;
      width:100%;
    }
    @media (min-width:640px){ /* ‚â• sm */
      .btn-grad{ width:auto; min-width:180px; }
    }
    .btn-grad:hover{ opacity:.97; transform:translateY(-1px); }
    .btn-grad:active{ transform:translateY(0) scale(.985); }

    /* Settings dropdown */
    .dropdown { position:relative; display:inline-block; }
    .dropdown-menu {
      position:absolute; right:0; top:100%; margin-top:.5rem;
      background:white; color:#0f172a; width:240px;
      border-radius:.75rem; box-shadow:0 10px 28px rgba(0,0,0,.15);
      border:1px solid rgba(2,6,23,.06);
      display:none; overflow:hidden; z-index:50;
    }
    .dropdown.open .dropdown-menu{ display:block; }
    .dropdown-item{ display:block; width:100%; text-align:left; padding:.6rem .9rem; font-size:.9rem; }
    .dropdown-item:hover{ background:#f1f5f9; }
  </style>
</head>

<body class="min-h-screen text-slate-800 antialiased">
  <div class="min-h-screen p-4 flex items-center justify-center">
    <main class="w-full max-w-3xl">
      <div class="bg-white/95 backdrop-blur-xl shadow-2xl rounded-3xl overflow-hidden ring-1 ring-slate-100">

        <!-- Header -->
        <header class="p-6 flex items-center justify-between" style="background:linear-gradient(90deg, var(--med-teal), var(--med-sky), var(--med-indigo));">
          <div class="flex items-center gap-4">
            <a href="./index.html?v=2025-09-17-49" aria-label="Home">
              <img src="./icons/icon-192.png?v=2025-09-17-49" alt="Victoria Nurse" class="h-14 w-14 rounded-2xl shadow"/>
            </a>
            <div>
              <h1 class="gradient-text text-2xl font-extrabold tracking-tight">Victoria Nurse</h1>
              <p class="gradient-text text-sm">We Care Together</p>
            </div>
          </div>

          <!-- Settings dropdown -->
          <div class="dropdown" id="settingsWrap">
            <button id="settingsBtn" class="text-white text-xl px-2 py-1 rounded-lg hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/50" aria-haspopup="true" aria-expanded="false" title="Settings">‚öô</button>
            <div class="dropdown-menu" id="settingsMenu" role="menu" aria-label="Settings">
              <button id="menuBranding" class="dropdown-item" role="menuitem">Branding &amp; Footer</button>
              <button id="menuTheme" class="dropdown-item" role="menuitem">Theme</button>
              <a id="menuHelp" href="./help.html?v=2025-09-17-49" class="dropdown-item" role="menuitem">Help</a>
            </div>
          </div>
        </header>

        <!-- Form -->
        <section class="p-6 grid gap-6 text-body" role="form" aria-label="Patient Vitals Form">
          <form id="formVitals" class="grid gap-6" autocomplete="off" novalidate>
            <div>
              <label for="patientName" class="block text-sm font-semibold mb-1">Patient Name</label>
              <input id="patientName" type="text" placeholder="Enter full name" class="vn-field vn-input w-full"/>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label for="temperature" class="block text-sm font-semibold mb-1">Temperature (¬∞C)</label>
                <input id="temperature" type="number" step="0.1" inputmode="decimal" class="vn-field vn-input w-full"/></div>
              <div><label for="pulse" class="block text-sm font-semibold mb-1">Pulse (bpm)</label>
                <input id="pulse" type="number" inputmode="numeric" class="vn-field vn-input w-full"/></div>
              <div><label for="respiratoryRate" class="block text-sm font-semibold mb-1">Respiratory Rate (breaths/min)</label>
                <input id="respiratoryRate" type="number" inputmode="numeric" class="vn-field vn-input w-full"/></div>

              <div>
                <label class="block text-sm font-semibold mb-1">Blood Pressure (mmHg)</label>
                <div class="grid grid-cols-2 gap-2">
                  <input id="sbp" type="number" inputmode="numeric" placeholder="SBP" class="vn-field vn-input w-full"/>
                  <input id="dbp" type="number" inputmode="numeric" placeholder="DBP" class="vn-field vn-input w-full"/>
                </div>
              </div>

              <div><label for="oxygenSaturation" class="block text-sm font-semibold mb-1">Oxygen Saturation (SpO‚ÇÇ %)</label>
                <input id="oxygenSaturation" type="number" inputmode="numeric" class="vn-field vn-input w-full"/></div>
              <div><label for="bloodSugar" class="block text-sm font-semibold mb-1">Blood Sugar Level (mg/dL)</label>
                <input id="bloodSugar" type="number" step="0.1" inputmode="decimal" class="vn-field vn-input w-full"/></div>

              <div><label for="weight" class="block text-sm font-semibold mb-1">Weight (kg)</label>
                <input id="weight" type="number" step="0.1" inputmode="decimal" class="vn-field vn-input w-full"/></div>

              <div class="md:col-span-2"><label for="pain" class="block text-sm font-semibold mb-1">Pain Assessment (0‚Äì10)</label>
                <input id="pain" type="number" min="0" max="10" inputmode="numeric" class="vn-field vn-input w-full"/></div>
            </div>

            <!-- Sharing Destinations (collapsed) -->
            <details id="shareSection" class="bg-white border border-slate-200 rounded-xl">
              <summary class="cursor-pointer px-4 py-3 font-semibold text-slate-700 flex items-center justify-between">
                <span>Sharing Destinations</span>
                <span class="text-slate-400">‚Ä∫</span>
              </summary>
              <div class="px-4 pb-4 grid gap-3">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <input id="wa1" class="vn-field vn-input w-full" inputmode="tel" placeholder="WhatsApp number #1 (+233...)"/>
                  <input id="wa2" class="vn-field vn-input w-full" inputmode="tel" placeholder="WhatsApp number #2 (optional)"/>
                  <input id="wa3" class="vn-field vn-input w-full" inputmode="tel" placeholder="WhatsApp number #3 (optional)"/>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <input id="groupPhones" class="vn-field vn-input w-full" placeholder="Group WhatsApp numbers (comma-separated)"/>
                  <input id="groupEmails" class="vn-field vn-input w-full" placeholder="Group emails (comma-separated)"/>
                </div>
              </div>
            </details>

            <!-- Notes + Dictation -->
            <div>
              <label for="notes" class="block text-sm font-semibold mb-1">Notes</label>
              <textarea id="notes" rows="7" placeholder="Observations, symptoms, instructions" class="vn-field vn-textarea w-full"></textarea>
              <div class="mt-2 flex justify-end">
                <button id="btnDictate" type="button" class="btn-grad sm:w-auto">üéôÔ∏è Dictate</button>
              </div>
            </div>

            <!-- Nurse + Branding -->
            <div>
              <div class="flex items-center justify-between">
                <label for="nurseName" class="block text-sm font-semibold mb-1">Prepared by (Nurse‚Äôs Name)</label>
                <label class="text-xs flex items-center gap-1 select-none">
                  <input id="rememberMe" type="checkbox" class="accent-sky-500"> Remember on this device (7 days)
                </label>
              </div>
              <input id="nurseName" type="text" placeholder="Enter nurse's full name" class="vn-field vn-input w-full"/>
            </div>

            <details id="settingsSection" class="bg-white border border-slate-200 rounded-xl">
              <summary class="cursor-pointer px-4 py-3 font-semibold text-slate-700 flex items-center justify-between">
                <span>Branding & Footer</span>
                <span class="text-slate-400">‚Ä∫</span>
              </summary>
              <div class="px-4 pb-4 grid gap-3">
                <input id="footerNote" class="vn-field vn-input w-full" placeholder="Footer note (e.g., Nurse‚Äôs signature or clinic name)"/>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-center">
                  <div>
                    <label class="block text-sm font-semibold mb-1">Custom Branding Logo (optional)</label>
                    <input id="brandLogo" type="file" accept="image/*" class="w-full text-sm"/>
                  </div>
                  <div class="text-xs text-slate-500">If provided, this logo appears in the PDF header instead of the default icon.</div>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1" for="themeSel">Theme</label>
                  <select id="themeSel" class="vn-field w-full">
                    <option value="system">System</option>
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                  </select>
                </div>
              </div>
            </details>

            <!-- Actions (slimmer buttons; centered) -->
            <div class="flex flex-col sm:flex-row flex-wrap gap-3 justify-center">
              <button id="btnPreview" type="button" class="btn-grad">Preview & PDF</button>
              <button id="btnWhatsApp" type="button" class="btn-grad">Share WhatsApp</button>
              <button id="btnEmail" type="button" class="btn-grad">Share Email</button>
            </div>
          </form>
        </section>

        <footer class="px-6 py-4 bg-white/70 text-sm flex items-center justify-between">
          <span class="font-medium" style="color:#0EA5E9">&copy; <span id="year"></span> Victoria Nurse</span>
          <span class="italic" style="color:#0EA5E9">Powered by: karlthebrown</span>
        </footer>
      </div>
    </main>
  </div>

  <!-- SW register -->
  <script>
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>navigator.serviceWorker.register(`./service-worker.js?v=2025-09-17-49`,{scope:'./'}).catch(()=>{}));
    }
  </script>

  <script>
    // Helpers
    const $ = (id)=>document.getElementById(id);
    const yearEl = $('year'); if (yearEl) yearEl.textContent = new Date().getFullYear();

    // Settings dropdown behavior
    const wrap = $('settingsWrap'), btn = $('settingsBtn'), menu = $('settingsMenu');
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); wrap.classList.toggle('open'); btn.setAttribute('aria-expanded', wrap.classList.contains('open')); });
    document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) { wrap.classList.remove('open'); btn.setAttribute('aria-expanded','false'); } });

    // Activate menu items
    $('menuBranding').addEventListener('click', ()=>{
      wrap.classList.remove('open'); btn.setAttribute('aria-expanded','false');
      const det = $('settingsSection'); if (!det.open) det.open = true;
      det.scrollIntoView({behavior:'smooth', block:'start'});
    });
    $('menuTheme').addEventListener('click', ()=>{
      wrap.classList.remove('open'); btn.setAttribute('aria-expanded','false');
      const det = $('settingsSection'); if (!det.open) det.open = true;
      const sel = $('themeSel'); sel.focus({preventScroll:true});
      det.scrollIntoView({behavior:'smooth', block:'center'});
    });

    // Remember Me (7 days)
    const EXP = 7*24*60*60*1000;
    function saveLocal(){
      if(!$('rememberMe').checked) return;
      const data={ nurse:$('nurseName').value, patient:$('patientName').value, ts:Date.now() };
      localStorage.setItem('vn_mem', JSON.stringify(data));
    }
    (function loadLocal(){
      const d = JSON.parse(localStorage.getItem('vn_mem')||'{}');
      if(d.ts && Date.now()-d.ts<EXP){
        if(d.nurse) $('nurseName').value = d.nurse;
        if(d.patient) $('patientName').value = d.patient;
        $('rememberMe').checked = true;
      } else {
        localStorage.removeItem('vn_mem');
      }
    })();

    // Dictation
    (function(){
      const btn = $('btnDictate'); const ta = $('notes');
      const has = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
      if(!has){ btn.disabled=true; btn.textContent='üéôÔ∏è Dictation not supported'; return; }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new SR(); rec.lang='en-US'; rec.continuous=false; rec.interimResults=true;
      let base='';
      btn.addEventListener('click', ()=>{
        base = ta.value; rec.start(); btn.textContent='üõë Stop';
      });
      rec.onresult = (e)=>{
        let final='', interim='';
        for(let i=0;i<e.results.length;i++){ const r=e.results[i]; (r.isFinal?final:interim)+=r[0].transcript; }
        ta.value = (base+' '+final+' '+interim).trim();
      };
      rec.onerror = ()=>{ btn.textContent='üéôÔ∏è Dictate'; alert('Dictation error'); };
      rec.onend = ()=>{ btn.textContent='üéôÔ∏è Dictate'; };
    })();

    // Build record (minimal for demo)
    function buildRecord(){
      return {
        patient: $('patientName').value.trim(),
        temp: $('temperature').value.trim(),
        pulse: $('pulse').value.trim(),
        rr: $('respiratoryRate').value.trim(),
        sbp: $('sbp').value.trim(),
        dbp: $('dbp').value.trim(),
        spo2: $('oxygenSaturation').value.trim(),
        sugar: $('bloodSugar').value.trim(),
        weight: $('weight').value.trim(),
        pain: $('pain').value.trim(),
        notes: $('notes').value.trim(),
        nurse: $('nurseName').value.trim(),
        footer: $('footerNote')?.value.trim()
      };
    }

    // PDF (simple header/footer; branding slot preserved)
    async function makePdf(rec){
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','pt','a4');
      const W = pdf.internal.pageSize.getWidth();

      pdf.setFillColor(14,165,233); pdf.rect(20, 20, W-40, 6, 'F');
      pdf.setFont('helvetica','bold'); pdf.setFontSize(20); pdf.setTextColor(14,165,233);
      pdf.text('Victoria Nurse', 28, 52);
      pdf.setFont('times','italic'); pdf.setFontSize(12); pdf.setTextColor(20,83,136);
      pdf.text('We Care Together', 28, 70);

      pdf.setFont('helvetica','normal'); pdf.setFontSize(12); pdf.setTextColor(31,41,55);
      let y=100;
      function line(t){ pdf.text(t, 28, y); y+=18; }
      line(`Patient: ${rec.patient||'-'}`);
      line(`Temp: ${rec.temp||'-'} ¬∞C, Pulse: ${rec.pulse||'-'} bpm, RR: ${rec.rr||'-'} /min`);
      line(`BP: ${rec.sbp||'-'}/${rec.dbp||'-'} mmHg, SpO‚ÇÇ: ${rec.spo2||'-'} %, Sugar: ${rec.sugar||'-'} mg/dL, Weight: ${rec.weight||'-'} kg`);
      line(`Pain: ${rec.pain||'-'}/10`);
      y+=6; pdf.text('Notes:', 28, y); y+=18;
      const lines = pdf.splitTextToSize(rec.notes||'-', W-56);
      pdf.text(lines, 28, y); y += lines.length*14 + 12;

      pdf.setFontSize(10); pdf.setTextColor(107,114,128);
      const left = `Prepared by: ${rec.nurse||'-'}`;
      const right = rec.footer ? rec.footer : 'Powered by: KarltheBrown';
      pdf.text(left, 28, y);
      pdf.text(right, W - (pdf.getTextWidth(right)+28), y);

      return pdf.output('blob');
    }

    // Sharing helpers
    function normalizePhone(p){ return (p||'').replace(/[^\d+]/g,'').trim(); }
    function parsePhones(str){ return (str||'').split(/[,;\s]+/).map(normalizePhone).filter(Boolean); }
    function unique(a){ return [...new Set(a)]; }
    function openWhatsApps(numbers, text){
      numbers.forEach((num, idx)=>{
        const url = num ? `https://wa.me/${encodeURIComponent(num)}?text=${encodeURIComponent(text)}` :
                          `https://wa.me/?text=${encodeURIComponent(text)}`;
        setTimeout(()=> window.open(url, '_blank'), idx*220);
      });
    }
    function shareText(rec){
      return [
        `Victoria Nurse ‚Äî Patient Vitals`,
        `Patient: ${rec.patient||'-'}`,
        `Temp: ${rec.temp||'-'} ¬∞C, Pulse: ${rec.pulse||'-'} bpm, RR: ${rec.rr||'-'} /min`,
        `BP: ${rec.sbp||'-'}/${rec.dbp||'-'} mmHg, SpO‚ÇÇ: ${rec.spo2||'-'} %, Sugar: ${rec.sugar||'-'} mg/dL, Weight: ${rec.weight||'-'} kg`,
        `Pain: ${rec.pain||'-'}/10`,
        `Notes: ${rec.notes||'-'}`,
        `Prepared by: ${rec.nurse||'-'}`,
        rec.footer ? `Footer: ${rec.footer}` : ''
      ].filter(Boolean).join('\n');
    }

    // Buttons
    $('btnPreview').addEventListener('click', async ()=>{
      const rec = buildRecord(); if ($('rememberMe').checked) saveLocal();
      const blob = await makePdf(rec);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `Victoria_Nurse_${(rec.patient||'patient').replace(/[^\w\-]+/g,'_')}_${new Date().toISOString().slice(0,10)}.pdf`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2500);
    });

    $('btnWhatsApp').addEventListener('click', ()=>{
      if (!navigator.onLine){ alert("You‚Äôre offline‚Äîtry again later."); return; }
      const rec = buildRecord(); if ($('rememberMe').checked) saveLocal();
      const text = shareText(rec);
      const nums = unique([
        normalizePhone($('wa1').value), normalizePhone($('wa2').value), normalizePhone($('wa3').value),
        ...parsePhones($('groupPhones').value)
      ]).filter(Boolean);
      openWhatsApps(nums.length?nums:[''], text);
      setTimeout(()=>{ window.location.href='./index.html?v=2025-09-17-49'; }, 800);
    });

    $('btnEmail').addEventListener('click', async ()=>{
      if (!navigator.onLine){ alert("You‚Äôre offline‚Äîtry again later."); return; }
      const rec = buildRecord(); if ($('rememberMe').checked) saveLocal();
      const blob = await makePdf(rec);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `Victoria_Nurse_${(rec.patient||'patient').replace(/[^\w\-]+/g,'_')}_${new Date().toISOString().slice(0,10)}.pdf`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2500);

      const subject = `Patient Vitals ‚Äî ${rec.patient||'Unnamed'}`;
      const body = shareText(rec);
      const emails = $('groupEmails').value.split(/[,;\s]+/).map(s=>s.trim()).filter(Boolean);
      window.location.href = `mailto:${encodeURIComponent(emails.join(','))}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

      setTimeout(()=>{ window.location.href='./index.html?v=2025-09-17-49'; }, 900);
    });
  </script>
</body>
</html>