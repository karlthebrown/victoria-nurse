<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Cache-Control" content="no-store, max-age=0"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Victoria Nurse ‚Äî We Care Together</title>

  <!-- Version -->
  <script>window.__VN_VER__="2025-09-23-02";</script>

  <!-- PWA + Icons -->
  <link rel="manifest" href="./manifest.webmanifest?v=2025-09-23-02"/>
  <meta name="theme-color" content="#0EA5E9"/>
  <link rel="icon" type="image/png" href="./icons/favicon.png?v=2025-09-23-02"/>
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180.png?v=2025-09-23-02"/>

  <!-- Tailwind + jsPDF (no html2canvas) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{ --med-teal:#14B8A6; --med-sky:#0EA5E9; --med-indigo:#1E40AF; --label:#0891B2; }
    body { background:#f9fafb; color:#1f2937; }
    .vn-field{ padding:.95rem 1.1rem; border-radius:.9rem; border:1px solid #cbd5e1; background:#fff; line-height:1.6rem; }
    .vn-field:focus{ outline:none; box-shadow:0 0 0 2px var(--label); border-color:var(--label); }
    .vn-input{ height:3.25rem; } .vn-textarea{ min-height:3.75rem; }
    .btn-grad{ background-image:linear-gradient(90deg,var(--med-teal),var(--med-sky),var(--med-indigo)); color:#fff; font-weight:700; padding:.75rem 1.1rem; border-radius:999px; box-shadow:0 10px 24px rgba(0,0,0,.22); transition:transform .12s,opacity .12s; width:100%; }
    @media (min-width:640px){ .btn-grad{ width:auto; min-width:170px; } }
    .btn-grad:hover{ opacity:.97; transform:translateY(-1px); }
    .btn-grad:active{ transform:translateY(0) scale(.985); }
    .dropdown { position:relative; display:inline-block; z-index:80; }
    .dropdown-menu{ position:absolute; right:0; top:100%; margin-top:.5rem; background:#fff; color:#0f172a; width:240px; border-radius:.75rem; box-shadow:0 10px 28px rgba(0,0,0,.15); border:1px solid rgba(2,6,23,.06); display:none; overflow:hidden; z-index:90; }
    .dropdown.open .dropdown-menu{ display:block; }
    .dropdown-item{ display:block; width:100%; text-align:left; padding:.6rem .9rem; font-size:.9rem; }
    .dropdown-item:hover{ background:#f1f5f9; }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:100; }
    .modal.on{ display:flex; }
    .modal-back{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
    .modal-panel{ position:relative; background:white; color:#0f172a; width:min(92vw, 560px); border-radius:1rem; box-shadow:0 20px 50px rgba(0,0,0,.35); overflow:hidden; }
  </style>
</head>

<body class="min-h-screen antialiased">
  <div class="min-h-screen p-4 flex items-start justify-center">
    <main class="w-full max-w-3xl">
      <div class="bg-white/95 backdrop-blur-xl shadow-2xl rounded-3xl ring-1 ring-slate-100">

<!-- Header -->
<header class="p-6 flex items-center justify-between bg-gradient-to-r from-teal-500 via-sky-500 to-indigo-800 rounded-t-3xl">
  <div class="flex items-center gap-4">
    <a href="./index.html?v=2025-09-23-02" aria-label="Home">
      <img src="./icons/icon-192.png?v=2025-09-23-02" alt="Victoria Nurse" class="h-14 w-14 rounded-2xl shadow"/>
    </a>
    <div>
      <div class="text-xl sm:text-2xl font-semibold">Victoria Nurse</div>
      <div class="text-xs sm:text-sm">We Care Together</div>
    </div>
  </div>

  <!-- Settings dropdown -->
  <div class="dropdown" id="settingsWrap">
    <button type="button" id="settingsBtn"
      class="text-white text-xl px-2 py-1 rounded-lg hover:bg-white/30 focus:outline-none focus:ring-2 focus:ring-white/60"
      aria-haspopup="true" aria-expanded="false" title="Settings">‚öô</button>
    <div class="dropdown-menu" id="settingsMenu" role="menu" aria-label="Settings">
      <button id="menuBranding" class="dropdown-item" role="menuitem">Branding &amp; Footer</button>
      <button id="menuTheme" class="dropdown-item" role="menuitem">Theme</button>
      <a id="menuHelp" href="./help.html?v=2025-09-23-02" class="dropdown-item" role="menuitem">Show Guide Page</a>
    </div>
  </div>
</header>

        <!-- Body -->
        <section class="p-6 grid gap-6" role="form" aria-label="Patient Vitals Form">
          <form id="formVitals" class="grid gap-6" autocomplete="off" novalidate>
            <!-- Patient -->
            <div>
              <label for="patientName" class="block text-sm font-semibold mb-1">Patient Name</label>
              <input id="patientName" type="text" placeholder="Enter full name" class="vn-field vn-input w-full"/>
            </div>

            <!-- Vitals -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="temperature" class="block text-sm font-semibold mb-1">Temperature (¬∞C)</label>
                <input id="temperature" type="number" step="0.1" inputmode="decimal" class="vn-field vn-input w-full"/>
              </div>
              <div>
                <label for="pulse" class="block text-sm font-semibold mb-1">Pulse (bpm)</label>
                <input id="pulse" type="number" inputmode="numeric" class="vn-field vn-input w-full"/>
              </div>
              <div>
                <label for="respiratoryRate" class="block text-sm font-semibold mb-1">Respiratory Rate (breaths/min)</label>
                <input id="respiratoryRate" type="number" inputmode="numeric" class="vn-field vn-input w-full"/>
              </div>

              <div>
                <label class="block text-sm font-semibold mb-1">Blood Pressure (mmHg)</label>
                <div class="grid grid-cols-2 gap-2">
                  <input id="sbp" type="number" inputmode="numeric" placeholder="SBP" class="vn-field vn-input w-full"/>
                  <input id="dbp" type="number" inputmode="numeric" placeholder="DBP" class="vn-field vn-input w-full"/>
                </div>
              </div>

              <div>
                <label for="oxygenSaturation" class="block text-sm font-semibold mb-1">Oxygen Saturation (SpO‚ÇÇ %)</label>
                <input id="oxygenSaturation" type="number" inputmode="numeric" class="vn-field vn-input w-full"/>
              </div>
              <div>
                <label for="bloodSugar" class="block text-sm font-semibold mb-1">Blood Sugar Level (mg/dL)</label>
                <input id="bloodSugar" type="number" step="0.1" inputmode="decimal" class="vn-field vn-input w-full"/>
              </div>
              <div>
                <label for="weight" class="block text-sm font-semibold mb-1">Weight (kg)</label>
                <input id="weight" type="number" step="0.1" inputmode="decimal" class="vn-field vn-input w-full"/>
              </div>
              <div class="md:col-span-2">
                <label for="pain" class="block text-sm font-semibold mb-1">Pain Assessment (0‚Äì10)</label>
                <input id="pain" type="number" min="0" max="10" inputmode="numeric" class="vn-field vn-input w-full"/>
              </div>
            </div>

            <!-- Medications -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-semibold mb-1">Medication ‚Äì Morning</label>
                <input id="medMorning" class="vn-field vn-input w-full" placeholder="e.g., Taken / Skipped (+note)"/>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">Medication ‚Äì Afternoon</label>
                <input id="medAfternoon" class="vn-field vn-input w-full" placeholder="e.g., Taken / Skipped (+note)"/>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">Medication ‚Äì Evening</label>
                <input id="medEvening" class="vn-field vn-input w-full" placeholder="e.g., Taken / Skipped (+note)"/>
              </div>
            </div>

            <!-- Sharing Destinations -->
            <details id="shareSection" class="bg-white border border-slate-200 rounded-xl">
              <summary class="cursor-pointer px-4 py-3 font-semibold text-slate-700 flex items-center justify-between">
                <span>Sharing Destinations</span>
                <span class="text-slate-400">‚Ä∫</span>
              </summary>
              <div class="px-4 pb-4 grid gap-3">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <input id="wa1" class="vn-field vn-input w-full" inputmode="tel" placeholder="WhatsApp number #1 (+233...)"/>
                  <input id="wa2" class="vn-field vn-input w-full" inputmode="tel" placeholder="WhatsApp number #2 (optional)"/>
                  <input id="wa3" class="vn-field vn-input w-full" inputmode="tel" placeholder="WhatsApp number #3 (optional)"/>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <input id="groupPhones" class="vn-field vn-input w-full" placeholder="Group WhatsApp numbers (comma-separated)"/>
                  <input id="groupEmails" class="vn-field vn-input w-full" placeholder="Group emails (comma-separated)"/>
                </div>
              </div>
            </details>

            <!-- Notes + Dictation -->
            <div>
              <label for="notes" class="block text-sm font-semibold mb-1">Notes</label>
              <textarea id="notes" rows="7" placeholder="Observations, symptoms, instructions" class="vn-field vn-textarea w-full"></textarea>
              <div class="mt-2 flex justify-end">
                <button id="btnDictate" type="button" class="btn-grad sm:w-auto">üéôÔ∏è Dictate</button>
              </div>
            </div>

            <!-- Nurse + Remember -->
            <div>
              <div class="flex items-center justify-between">
                <label for="nurseName" class="block text-sm font-semibold mb-1">Prepared by (Nurse‚Äôs Name)</label>
                <label class="text-xs flex items-center gap-1 select-none">
                  <input id="rememberMe" type="checkbox" class="accent-sky-500"> Remember on this device (7 days)
                </label>
              </div>
              <input id="nurseName" type="text" placeholder="Enter nurse's full name" class="vn-field vn-input w-full"/>
            </div>

            <!-- Actions -->
            <div class="flex flex-col sm:flex-row flex-wrap gap-3 justify-center">
              <button id="btnPreview"  type="button" class="btn-grad">Preview & PDF</button>
              <button id="btnWhatsApp" type="button" class="btn-grad">Share WhatsApp</button>
              <button id="btnEmail"    type="button" class="btn-grad">Share Email</button>
            </div>
          </form>
        </section>

        <!-- Footer -->
        <footer class="px-6 py-4 bg-white/70 text-sm flex items-center justify-between">
          <span class="font-medium" style="color:#0EA5E9">&copy; <span id="year"></span> Victoria Nurse</span>
          <span class="italic" style="color:#0EA5E9">Powered by: karlthebrown</span>
        </footer>
      </div>
    </main>
  </div>

  <!-- SW register -->
  <script>
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>navigator.serviceWorker.register(`./service-worker.js?v=${window.__VN_VER__}`,{scope:'./'}).catch(()=>{}));
    }
  </script>

  <!-- App logic -->
  <script>
  (function(){
    function onReady(fn){ if (document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
    onReady(function(){
      const $ = (id)=>document.getElementById(id);
      $('year') && ( $('year').textContent = new Date().getFullYear() );

      /* Settings dropdown (minimal) */
      const wrap = $('settingsWrap'), btn = $('settingsBtn'), menu = $('settingsMenu');
      const openDD = ()=>{ wrap?.classList.add('open'); btn?.setAttribute('aria-expanded','true'); };
      const closeDD= ()=>{ wrap?.classList.remove('open'); btn?.setAttribute('aria-expanded','false'); };
      btn?.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); wrap?.classList.contains('open')?closeDD():openDD(); });
      menu?.addEventListener('click', (e)=> e.stopPropagation());
      document.addEventListener('click', ()=> closeDD());
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDD(); });

      /* Settings modal (stub controls kept for future expansion) */
      const modal=$('settingsModal'), back=$('settingsBackdrop'), mClose=$('settingsClose'), mCancel=$('settingsCancel'), mSave=$('settingsSave'), themeSel=$('themeSel'), menuBranding=$('menuBranding'), menuTheme=$('menuTheme');
      const openModal = ()=>{ modal?.classList.add('on'); modal?.setAttribute('aria-hidden','false'); };
      const closeModal= ()=>{ modal?.classList.remove('on'); modal?.setAttribute('aria-hidden','true'); };
      menuBranding?.addEventListener('click', ()=>{ closeDD(); openModal(); });
      menuTheme?.addEventListener('click', ()=>{ closeDD(); openModal(); themeSel?.focus({preventScroll:true}); });
      back?.addEventListener('click', closeModal); mClose?.addEventListener('click', closeModal); mCancel?.addEventListener('click', closeModal);
      mSave?.addEventListener('click', ()=>{ localStorage.setItem('vn_theme', themeSel?.value || 'system'); closeModal(); alert('Settings saved'); });

      /* Remember Me (7 days) */
      const EXP = 7*24*60*60*1000;
      function saveRemember(){
        if(!$('rememberMe')?.checked) return;
        const data={ nurse:$('nurseName')?.value||'', patient:$('patientName')?.value||'', ts:Date.now() };
        localStorage.setItem('vn_mem', JSON.stringify(data));
      }
      (function loadRemember(){
        try{
          const d = JSON.parse(localStorage.getItem('vn_mem')||'{}');
          if(d.ts && Date.now()-d.ts<EXP){
            if(d.nurse && $('nurseName')) $('nurseName').value=d.nurse;
            if(d.patient && $('patientName')) $('patientName').value=d.patient;
            $('rememberMe') && ($('rememberMe').checked=true);
          } else { localStorage.removeItem('vn_mem'); }
        }catch(_){}
      })();

      /* Dictation */
      (function(){
        const dBtn = $('btnDictate'), ta = $('notes');
        if(!dBtn) return;
        const has = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
        if(!has){ dBtn.disabled=true; dBtn.textContent='üéôÔ∏è Dictation not supported'; return; }
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new SR(); rec.lang='en-US'; rec.continuous=false; rec.interimResults=true;
        let base='';
        dBtn.addEventListener('click', ()=>{ base = ta?.value||''; rec.start(); dBtn.textContent='üõë Stop'; });
        rec.onresult = (e)=>{
          let final='', interim='';
          for(let i=0;i<e.results.length;i++){ const r=e.results[i]; (r.isFinal?final:interim)+=r[0].transcript; }
          if(ta) ta.value = (base+' '+final+' '+interim).trim();
        };
        rec.onerror = ()=>{ dBtn.textContent='üéôÔ∏è Dictate'; alert('Dictation error'); };
        rec.onend   = ()=>{ dBtn.textContent='üéôÔ∏è Dictate'; };
      })();

      /* Record builder */
      function g(id){ return (document.getElementById(id)?.value || '').trim(); }
      function record(){
        return {
          patient:g('patientName'), temp:g('temperature'), pulse:g('pulse'), rr:g('respiratoryRate'),
          sbp:g('sbp'), dbp:g('dbp'), spo2:g('oxygenSaturation'), sugar:g('bloodSugar'),
          weight:g('weight'), pain:g('pain'),
          meds:{ morning:g('medMorning'), afternoon:g('medAfternoon'), evening:g('medEvening') },
          notes:g('notes'), nurse:g('nurseName'), footer:g('footerNote')
        };
      }
      function shareText(r){
        return [
          `Victoria Nurse ‚Äî Patient Vitals`,
          `Patient: ${r.patient||'-'}`,
          `BP: ${r.sbp||'-'}/${r.dbp||'-'} mmHg | HR: ${r.pulse||'-'} bpm | Temp: ${r.temp||'-'} ¬∞C`,
          `SpO‚ÇÇ: ${r.spo2||'-'}% | RR: ${r.rr||'-'}/min | Weight: ${r.weight||'-'} kg | Sugar: ${r.sugar||'-'} mg/dL`,
          `Meds: AM ${r.meds.morning||'-'} | PM ${r.meds.afternoon||'-'} | EV ${r.meds.evening||'-'}`,
          `Pain: ${r.pain||'-'}/10`,
          `Notes: ${r.notes||'-'}`,
          `Prepared by: ${r.nurse||'-'}`,
          r.footer ? `Footer: ${r.footer}` : 'Powered by: KarltheBrown'
        ].filter(Boolean).join('\n');
      }

      /* PDF (text-only layout to avoid CORS/taint issues) */
      async function makePdf(rec){
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('PDF library not loaded'); return null; }
        const pdf = new jsPDF('p','pt','a4');
        const W = pdf.internal.pageSize.getWidth();

        pdf.setFillColor(14,165,233); pdf.rect(20, 20, W-40, 6, 'F');
        pdf.setFont('helvetica','bold'); pdf.setFontSize(20); pdf.setTextColor(14,165,233); pdf.text('Victoria Nurse', 28, 52);
        pdf.setFont('times','italic'); pdf.setFontSize(12); pdf.setTextColor(20,83,136); pdf.text('We Care Together', 28, 70);
        pdf.setFont('helvetica','normal'); pdf.setFontSize(12); pdf.setTextColor(31,41,55);

        let y=98, line=t=>{ pdf.text(t,28,y); y+=18; };
        line(`Patient: ${rec.patient||'-'}`);
        line(`BP: ${rec.sbp||'-'}/${rec.dbp||'-'} mmHg | HR: ${rec.pulse||'-'} bpm | Temp: ${rec.temp||'-'} ¬∞C`);
        line(`SpO‚ÇÇ: ${rec.spo2||'-'}% | RR: ${rec.rr||'-'}/min | Weight: ${rec.weight||'-'} kg | Sugar: ${rec.sugar||'-'} mg/dL`);
        line(`Pain: ${rec.pain||'-'}/10`);
        y+=6; pdf.text('Medications:', 28, y); y+=18;
        line(`AM: ${rec.meds.morning||'-'}`); line(`PM: ${rec.meds.afternoon||'-'}`); line(`EV: ${rec.meds.evening||'-'}`);
        y+=6; pdf.text('Notes:', 28, y); y+=18;
        const lines = pdf.splitTextToSize(rec.notes||'-', W-56); pdf.text(lines, 28, y); y += lines.length*14 + 12;

        pdf.setFontSize(10); pdf.setTextColor(107,114,128);
        const left = `Prepared by: ${rec.nurse||'-'}`;
        const right = rec.footer ? rec.footer : 'Powered by: KarltheBrown';
        pdf.text(left, 28, y);
        pdf.text(right, W - (pdf.getTextWidth(right)+28), y);

        return pdf.output('blob');
      }

      /* === Buttons ‚Äî iOS/Safari-safe === */

      // Preview & PDF (download in the same user gesture)
      document.getElementById('btnPreview')?.addEventListener('click', async function(){
        const rec = record();
        const blob = await makePdf(rec);
        if(!blob) return;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Victoria_Nurse_${(rec.patient||'patient').replace(/[^\w\-]+/g,'_')}_${new Date().toISOString().slice(0,10)}.pdf`;
        a.click(); // synchronous download
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      }, {passive:true});

      // WhatsApp (use native scheme synchronously, then quick fallback to wa.me)
      document.getElementById('btnWhatsApp')?.addEventListener('click', function(){
        const r = record();
        const text = encodeURIComponent(shareText(r));
        const norm = s => (s||'').replace(/[^\d+]/g,'');
        const phones = [
          norm(document.getElementById('wa1')?.value),
          norm(document.getElementById('wa2')?.value),
          norm(document.getElementById('wa3')?.value),
          ...(document.getElementById('groupPhones')?.value||'').split(/[,;\s]+/).map(norm)
        ].filter(Boolean);
        const num = phones[0] || '';

        const native = `whatsapp://send?${num?`phone=${encodeURIComponent(num)}&`:''}text=${text}`;
        try { window.location.href = native; } catch(_) {}
        setTimeout(()=>{ window.location.href = num ? `https://wa.me/${encodeURIComponent(num)}?text=${text}`
                                                   : `https://wa.me/?text=${text}`; }, 350);
      }, {passive:true});

      // Email (mailto assigned synchronously)
      document.getElementById('btnEmail')?.addEventListener('click', function(){
        const r = record();
        const subject = encodeURIComponent(`Patient Vitals ‚Äî ${r.patient||'Unnamed'}`);
        const body    = encodeURIComponent(shareText(r));
        const emails  = (document.getElementById('groupEmails')?.value||'').split(/[,;\s]+/).map(s=>s.trim()).filter(Boolean).join(',');
        window.location.href = `mailto:${encodeURIComponent(emails)}?subject=${subject}&body=${body}`;
      }, {passive:true});

      // Light-weight self refresh (prevents stale assets on first boot)
      (function(){
        const VER = window.__VN_VER__;
        const KEY = `vn_boot_${VER}`;
        if (!localStorage.getItem(KEY)) {
          try{ localStorage.setItem(KEY,'1'); location.replace(location.pathname + location.search + location.hash); }catch(_){}
        }
      })();
    });
  })();
  </script>
</body>
</html>