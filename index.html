<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Victoria Nurse — Care Together. Stay Together.</title>

  <style>
    :root{
      --teal-300:#5ecfc6; --teal-500:#10afa0; --teal-600:#0e998c; --teal-700:#0b7f74;
      --blue-400:#60a5fa;
      --slate-800:#1f2937; --slate-700:#334155; --slate-600:#475569; --slate-500:#64748b;
      --bg:#ffffff; --muted:#f8fafc; --border:#e6eef5;
      --grad: linear-gradient(135deg, var(--teal-500), var(--blue-400));
      --ring: 0 0 0 4px rgba(16,175,160,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--slate-700);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Ubuntu,"Noto Sans",sans-serif;
      padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);
    }

    /* Header: logo centered above smaller tagline */
    header{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:.6rem;
      padding: 1.1rem 1rem 0.75rem;
      border-bottom:1px solid var(--border); background:#fff; position:sticky; top:0; z-index:10;
      text-align:center;
    }
    .logo img{ width:48px; height:48px; border-radius:10px; display:block; }
    .tagline{
      margin:0; line-height:1.1;
      font-weight:600; font-size:1rem; /* smaller & lighter */
      letter-spacing:.2px;
    }
    .tagline .care{
      background: var(--grad); -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .tagline .stay{ color: var(--teal-600); }

    /* Top nav buttons – now same look as Share buttons (gradient + white text) */
    .topnav{
      padding: .6rem clamp(1rem, 3vw, 2rem);
      display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center;
      border-bottom:1px solid var(--border); background:#fff;
    }
    .navbtn{
      padding:.7rem 1.05rem; border-radius:12px; border:1px solid transparent;
      background: var(--grad); cursor:pointer;
      box-shadow: 0 8px 20px rgba(58,169,255,.22), 0 6px 14px rgba(16,175,160,.22);
      transition: transform .12s ease, box-shadow .12s ease;
      color: #fff;                         /* match Share buttons */
      font-weight:700;
    }
    .navbtn:hover{ transform: translateY(-1px); }
    .navbtn[data-active="true"]{
      background:#fff; color:var(--teal-700); border-color:var(--teal-300); box-shadow:none;
    }

    main{ padding: 1.2rem clamp(1rem, 3vw, 2rem) 3rem; max-width:1100px; margin:0 auto; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:18px; padding:clamp(1rem,2vw,1.5rem); box-shadow:0 10px 28px rgba(2,8,23,.03); margin-bottom:1rem; }
    h2.section-title{ margin:0 0 .75rem; font-size:1.05rem; font-weight:800; color:var(--teal-700); } /* teal-blue titles */

    form{ display:grid; gap:1rem; }
    .grid{ display:grid; gap:1rem; }
    .cols-1{ grid-template-columns: 1fr; }
    .cols-2{ grid-template-columns: repeat(2, minmax(0,1fr));}
    .cols-3{ grid-template-columns: repeat(3, minmax(0,1fr));}
    @media (max-width: 720px){ .cols-2,.cols-3{ grid-template-columns: 1fr; } }

    label{ display:block; font-size:.9rem; font-weight:700; color:var(--slate-600); margin-bottom:.45rem; }
    .hint{ font-size:.8rem; color:var(--slate-500); margin-top:.35rem;}

    input, select, textarea{
      width:100%; padding:.8rem .9rem; border-radius: 12px; border:1.5px solid #e7eef7;
      background:#fff; color: var(--slate-800); outline:none;
      transition: border-color .15s, box-shadow .15s, background .15s; box-shadow: inset 0 0 0 0 rgba(0,0,0,0);
      -webkit-tap-highlight-color: transparent;
    }
    textarea{ min-height:110px; resize:vertical; }
    input:focus, select:focus, textarea:focus{ border-color: transparent; box-shadow: var(--ring), 0 0 0 1.5px var(--teal-500); }

    .teal-input{
      border-color: var(--teal-300); color: var(--teal-700);
      background:
        linear-gradient(#fff,#fff) padding-box,
        linear-gradient(135deg, var(--teal-300), var(--teal-500)) border-box;
      border:1.5px solid transparent;
    }
    .teal-input:focus{ box-shadow: var(--ring), 0 0 0 1.5px var(--teal-500); }

    /* Slightly taller Medication select */
    #medTime{ padding:.95rem 1rem; min-height:52px; }

    .actions{ display:flex; gap:.75rem; flex-wrap:wrap; justify-content:flex-end; margin-top:.5rem; }
    .btn{
      display:inline-block; padding:.85rem 1.1rem; border-radius:12px; border:0; background: var(--grad);
      color:#fff; font-weight:700; letter-spacing:.2px;
      box-shadow: 0 10px 24px rgba(58,169,255,.25), 0 6px 14px rgba(16,175,160,.28);
      cursor:pointer; transition: transform .12s, box-shadow .12s, opacity .12s;
    }
    .btn:hover{ transform: translateY(-1px); }

    footer{
      padding: 1.25rem; text-align:center; color: var(--slate-600);
      border-top:1px solid var(--border); background:#fff;
    }
    .powered{ font-weight:600; }
    .powered .label{ color: var(--teal-600); }   /* teal for “Powered by:” */
    .powered .ktb{
      color: var(--blue-400);                     /* stylish light blue */
      font-style: italic;                         /* italic, not bold */
      font-weight: 500;
      letter-spacing:.2px;
    }
  </style>
</head>
<body>

  <header>
    <!-- Cross-logo centered above slogan -->
    <div class="logo" aria-hidden="true">
      <img src="icons/icon-192.png" alt="App logo" />
    </div>
    <p class="tagline"><span class="care">Care Together.</span> <span class="stay">Stay Together.</span></p>
  </header>

  <!-- Top nav now matches Share buttons (same gradient + white text) -->
  <div class="topnav">
    <button class="navbtn" id="btn-info"   data-target="#section-info">Patient Information</button>
    <button class="navbtn" id="btn-vitals" data-target="#section-vitals">Patient Vital Signs</button>
  </div>

  <main id="main">
    <!-- Patient Information -->
    <section class="card" id="section-info">
      <h2 class="section-title">Patient Information</h2>
      <form id="infoForm" autocomplete="on">
        <!-- Order: patient name → gender → WhatsApp -->
        <div class="grid cols-3">
          <div>
            <label for="patientName">Patient name</label>
            <input id="patientName" name="patientName" placeholder="e.g., Kofi Asare" />
          </div>
          <div>
            <label for="gender">Gender</label>
            <select id="gender" name="gender">
              <option value="">Select…</option>
              <option>Female</option>
              <option>Male</option>
            </select>
          </div>
          <div>
            <label for="whatsapp">Recipient WhatsApp Number (with country code)</label>
            <input id="whatsapp" name="whatsapp" inputmode="tel" placeholder="+233xxxxxxxxx" />
          </div>
        </div>

        <div class="grid cols-3">
          <div>
            <label for="weekOf">Week of</label>
            <input id="weekOf" class="teal-input" name="weekOf" type="date" />
            <div class="hint">dd/mm/yyyy</div>
          </div>
        </div>
      </form>
    </section>

    <!-- Patient Vital Signs -->
    <section class="card" id="section-vitals">
      <h2 class="section-title">Patient Vital Signs</h2>
      <form id="vitalsForm" autocomplete="on">
        <!-- Order: Date, Systolic, Diastolic, HR, Temp, RR, SpO2, Sugar, Weight, Medication, Notes, Prepared by -->
        <div class="grid cols-3">
          <div>
            <label for="vdate">Date</label>
            <input id="vdate" name="vdate" type="date" class="teal-input" />
            <div class="hint">dd/mm/yyyy</div>
          </div>
          <input id="vtime" name="vtime" type="hidden" />
          <div>
            <label for="bpSys">Systolic (mmHg)</label>
            <input id="bpSys" name="bpSys" type="number" min="0" placeholder="e.g., 120" />
          </div>
          <div>
            <label for="bpDia">Diastolic (mmHg)</label>
            <input id="bpDia" name="bpDia" type="number" min="0" placeholder="e.g., 78" />
          </div>
        </div>

        <div class="grid cols-3">
          <div>
            <label for="hr">Heart Rate (bpm)</label>
            <input id="hr" name="hr" type="number" min="0" placeholder="e.g., 76" />
          </div>
          <div>
            <label for="temp">Temperature (°C)</label>
            <input id="temp" name="temp" type="number" step="0.1" placeholder="e.g., 36.7" />
          </div>
          <div>
            <label for="resp">Respiratory Rate (breaths/min)</label>
            <input id="resp" name="resp" type="number" min="0" placeholder="e.g., 16" />
          </div>
        </div>

        <div class="grid cols-3">
          <div>
            <label for="spo2">SpO₂ (%)</label>
            <input id="spo2" name="spo2" type="number" min="0" max="100" placeholder="e.g., 98" />
          </div>
          <div>
            <label for="glucose">Blood Sugar (mg/dL)</label>
            <input id="glucose" name="glucose" type="number" min="0" placeholder="e.g., 95" />
          </div>
          <div>
            <label for="weight">Weight (kg) (optional)</label>
            <input id="weight" name="weight" type="number" step="0.1" placeholder="e.g., 72.5" />
          </div>
        </div>

        <!-- Medication dropdown + text -->
        <div class="grid cols-2">
          <div>
            <label for="medTime">Medication</label>
            <select id="medTime" name="medTime">
              <option value="">Select…</option>
              <option value="Morning">Medication — Morning</option>
              <option value="Afternoon">Medication — Afternoon</option>
              <option value="Evening">Medication — Evening</option>
            </select>
          </div>
          <div>
            <label for="medText">Medication details</label>
            <input id="medText" name="medText" placeholder="e.g., Metformin 500mg" />
          </div>
        </div>

        <!-- Observations ABOVE Prepared by -->
        <div class="grid cols-1">
          <div>
            <label for="notes">Observations, symptoms…</label>
            <textarea id="notes" name="notes" placeholder="Notes"></textarea>
          </div>
        </div>

        <!-- Prepared by (single box) -->
        <div class="grid cols-1">
          <div>
            <label for="nurseFull">Prepared by: Nurse</label>
            <input id="nurseFull" name="nurseFull" placeholder="e.g., Ama Mensah" />
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn" id="shareWhatsApp">Share via WhatsApp</button>
          <button type="button" class="btn" id="shareEmail">Share via Email (PDF)</button>
        </div>
      </form>
    </section>
  </main>

  <footer>
    <span class="powered"><span class="label">Powered by:</span> <span class="ktb">KarltheBrown</span></span>
  </footer>

  <script>
    // Smooth-scroll buttons + active highlighting
    const infoBtn = document.getElementById('btn-info');
    const vitalsBtn = document.getElementById('btn-vitals');
    const infoSec = document.getElementById('section-info');
    const vitalsSec = document.getElementById('section-vitals');

    [infoBtn, vitalsBtn].forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = document.querySelector(btn.dataset.target);
        target?.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });

    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(e.target.id==='section-info')  infoBtn.dataset.active = e.isIntersecting ? 'true':'false';
        if(e.target.id==='section-vitals') vitalsBtn.dataset.active = e.isIntersecting ? 'true':'false';
      });
    },{rootMargin:'-40% 0px -50% 0px', threshold:0.01});
    io.observe(infoSec); io.observe(vitalsSec);

    // Auto-set current time (hidden) when user focuses vitals
    const vtime = document.getElementById('vtime');
    function setNow(){
      const now = new Date();
      const pad = n => String(n).padStart(2,'0');
      const t = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
      if (vtime) vtime.value = t;
    }
    document.getElementById('vitalsForm')?.addEventListener('focusin', setNow);

    // Medication hint updates
    const medTime = document.getElementById('medTime');
    const medText = document.getElementById('medText');
    const hints = {
      'Morning':'e.g., Metformin 500mg',
      'Afternoon':'e.g., Lisinopril 10mg',
      'Evening':'e.g., Atorvastatin 20mg'
    };
    medTime.addEventListener('change', ()=>{ medText.placeholder = hints[medTime.value] || 'Medication details'; });

    // Helpers
    const v = id => document.getElementById(id)?.value?.trim() || '';
    function normalizedPhone(raw){ return (raw || '').replace(/[^\d+]/g,''); }

    function buildShareText(){
      const lines = [
        'Patient Vitals',
        `Patient: ${v('patientName') || '—'} (${v('gender') || '—'})`,
        `Week of: ${v('weekOf') || '—'}`,
        '',
        'Vitals:',
        `• Date: ${v('vdate') || '—'}  Time: ${v('vtime') || '(auto)'}`,
        `• Systolic/Diastolic: ${v('bpSys') || '—'}/${v('bpDia') || '—'} mmHg`,
        `• Heart Rate: ${v('hr') || '—'} bpm`,
        `• Temperature: ${v('temp') || '—'} °C`,
        `• Respiratory Rate: ${v('resp') || '—'} /min`,
        `• SpO₂: ${v('spo2') || '—'} %`,
        `• Blood Sugar: ${v('glucose') || '—'} mg/dL`,
        v('weight') ? `• Weight: ${v('weight')} kg` : null,
        v('notes') ? `• Observations: ${v('notes')}` : null,
        v('medTime') && v('medText') ? `• Medication (${v('medTime')}): ${v('medText')}` : null,
        '',
        v('nurseFull') ? `Prepared by: Nurse ${v('nurseFull')}` : null
      ].filter(Boolean);
      return lines.join('\n');
    }

    // WhatsApp share
    document.getElementById('shareWhatsApp')?.addEventListener('click', ()=>{
      setNow();
      const phone = normalizedPhone(v('whatsapp'));
      const base = phone ? `https://wa.me/${encodeURIComponent(phone)}` : 'https://wa.me/';
      const url = `${base}?text=${encodeURIComponent(buildShareText())}`;
      window.open(url, '_blank');
    });

    // ---- Robust jsPDF loader to avoid "Could not generate PDF" errors ----
    async function ensureJsPDF() {
      if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
        s.onload = resolve; s.onerror = reject;
        document.head.appendChild(s);
      });
      if (!window.jspdf?.jsPDF) throw new Error('jsPDF failed to load');
      return window.jspdf.jsPDF;
    }

    async function loadLogoDataURL() {
      try{
        const res = await fetch('icons/icon-192.png', { cache: 'no-store' });
        const blob = await res.blob();
        return await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      }catch{ return null; }
    }

    async function generatePdfBlob() {
      const jsPDF = await ensureJsPDF();
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const pageW = doc.internal.pageSize.getWidth();

      // Header: logo + slogan
      const logoData = await loadLogoDataURL();
      if (logoData) doc.addImage(logoData, 'PNG', 40, 32, 40, 40);

      doc.setFont('helvetica','bold');
      doc.setFontSize(14);
      doc.setTextColor(16,175,160); // teal
      doc.text('Care Together.', 90, 48);
      doc.setTextColor(14,153,140);
      doc.text('Stay Together.', 200, 48);

      // Title
      doc.setTextColor(31,41,55);
      doc.setFontSize(16);
      doc.setFont('helvetica','bold');
      doc.text('Patient Information & Vital Signs', 40, 88);

      doc.setFont('helvetica','normal');
      doc.setFontSize(12);
      const left = 40, gap = 18, start = 120;

      const lines = [
        [`Patient`, v('patientName') || '—'],
        [`Gender`, v('gender') || '—'],
        [`WhatsApp`, v('whatsapp') || '—'],
        [`Week of`, v('weekOf') || '—'],
        [`Date`, v('vdate') || '—'],
        [`Time`, v('vtime') || '(auto)'],
        [`Systolic/Diastolic`, `${v('bpSys') || '—'}/${v('bpDia') || '—'} mmHg`],
        [`Heart Rate`, `${v('hr') || '—'} bpm`],
        [`Temperature`, `${v('temp') || '—'} °C`],
        [`Respiratory Rate`, `${v('resp') || '—'} /min`],
        [`SpO₂`, `${v('spo2') || '—'} %`],
        [`Blood Sugar`, `${v('glucose') || '—'} mg/dL`],
        [v('weight') ? `Weight` : null, v('weight') ? `${v('weight')} kg` : null],
        [v('notes') ? `Observations` : null, v('notes') || null],
        [v('medTime') && v('medText') ? `Medication` : null, v('medTime') && v('medText') ? `${v('medTime')}: ${v('medText')}` : null],
        [v('nurseFull') ? `Prepared by` : null, v('nurseFull') ? `Nurse ${v('nurseFull')}` : null],
      ].filter(r => r[0]);

      let y = start;
      lines.forEach(([k,val])=>{
        doc.setTextColor(71,85,105); // label
        doc.text(`${k}:`, left, y);
        doc.setTextColor(31,41,55); // value
        const text = doc.splitTextToSize(val, pageW - left - 40 - 80);
        doc.text(text, left + 140, y);
        y += Array.isArray(text) ? gap * Math.max(1, text.length) : gap;
      });

      // Footer
      doc.setDrawColor(230, 238, 245);
      doc.line(40, y+10, pageW-40, y+10);
      doc.setFontSize(10);
      doc.setTextColor(14,153,140);  // teal for “Powered by:”
      doc.setFont('helvetica','bold');
      doc.text('Powered by:', 40, y+28);
      doc.setTextColor(96,165,250);  // light blue name
      doc.setFont('helvetica','italic');
      doc.text('KarltheBrown', 105, y+28);

      return doc.output('blob');
    }

    document.getElementById('shareEmail')?.addEventListener('click', async ()=>{
      setNow();
      try{
        const blob = await generatePdfBlob();
        const filename = `Patient-Vitals-${v('patientName') || 'Unknown'}.pdf`;
        const file = (typeof File === 'function')
          ? new File([blob], filename, { type: 'application/pdf' })
          : { name: filename }; // fallback stub

        // Try native share with file (mobile)
        if (navigator.canShare && navigator.canShare({ files: [file] }) && file instanceof File) {
          await navigator.share({
            files: [file],
            title: 'Patient Vitals',
            text: 'Patient information & vital signs attached.'
          });
          return;
        }

        // Fallback: download, then open mailto
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);

        const subject = encodeURIComponent(`Patient Vitals — ${v('patientName') || 'Unknown'} (${v('vdate') || ''})`);
        const body = encodeURIComponent(buildShareText() + '\n\nPDF has been downloaded; please attach it to this email.');
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      }catch(err){
        alert('Could not generate PDF. Please try again.');
        console.error(err);
      }
    });

    // Prevent default submits (no persistence)
    document.getElementById('infoForm')?.addEventListener('submit', e=>e.preventDefault());
    document.getElementById('vitalsForm')?.addEventListener('submit', e=>e.preventDefault());

    // Service worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const SW_VERSION = 'v16';
        const swUrl = new URL('service-worker.js?v=' + SW_VERSION, window.location.href);
        navigator.serviceWorker.register(swUrl.toString())
          .then(reg => reg.update())
          .catch(console.error);
      });
    }
  </script>
</body>
</html>
